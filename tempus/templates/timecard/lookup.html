{% extends "base.html" %}

{% block page_script %}
<script type="text/javascript">
    var empty_timecard = {"start_date": "",
                          "end_date": "",
                          "hours_today": "",
                          "hours_total": ""
                         };
    var empty_pairs = [["", ""]];
    var active_timecard = null;

    function clear_details() {
        show_stamps(empty_pairs);
        show_details(empty_timecard);
        show_image("{{ STATIC_URL }}/images/blank.jpg");
        active_timecard = null;
    }

    function show_error(msg) {
        document.getElementById("errr").innerHTML = msg;
    }

    function show_name(profile) {
        document.getElementById("profile").innerHTML = profile.first_name + " " + profile.last_name;
    }

    function show_image(image) {
        $("#profile_face").attr("src", image);
    }

    function show_timecards(timecards) {
        var cards = "<form><table>";
        var count = 1;
        var heads = ["<td>", "<tr><td>"];
        var tails = ["</td></tr>", "</td>"];

        $.each(timecards, function(i, item) {
            cards = cards + heads[count % 2] + "<input type=\"radio\" name=\"timecard_select\" onclick=\"lookup_timecard('" + item[1] + "')\"/>" + item[0] + tails[count % 2];
            count = count + 1;
        });

        cards = cards + "</table></form>";

        document.getElementById("timecards").innerHTML = cards;

        if (count == 2) {
            $(".timecard_select").prop("checked", true);
            lookup_timecard(timecards[0][1]);
        }
    }

    function show_details(timecard) {
        var details = "<table>";

        details = details + "<tr><td>Start Date:</td><td>"  + timecard.start_date + "</td></tr>";
        details = details + "<tr><td>End Date:</td><td>"    + timecard.end_date + "</td></tr>";
        details = details + "<tr><td>Hours Today:</td><td>" + timecard.hours_today + "</td></tr>";
        details = details + "<tr><td>Hours Total:</td><td>" + timecard.hours_total + "</td></tr>";
        details = details + "</table>";

        document.getElementById("details").innerHTML = details;
    }

    function cleanup_timestamp(timestamp) {
        var stamp;

        if (timestamp) {
            stamp = timestamp.split(": ")[1].split(".")[0];

        } else {
            stamp = " ";
        }

        return stamp;
    }

    function show_stamps(pairs) {
        var stamps = "<table>";
        stamps = stamps + "<tr><td>" + "Date" + "</td><td>" + "Time In" + "</td><td>" + "Time Out" + "</td></tr>";

        $.each(pairs, function(i, item) {
            var sin = cleanup_timestamp(item[0]).split(" ");
            var sout = cleanup_timestamp(item[1]).split(" ");

            stamps = stamps + "<tr><td>" + sin[0] + "</td><td>" + sin[1] + "</td><td>" + sout[1] + "</td></tr>";
        });

        stamps = stamps + "</table>";

        document.getElementById("stamps").innerHTML = stamps;
    }

    function lookup_profile_rfid(id) {
        new $.getJSON("/api/v1/profile/?rfid__rfid=" + id,
                      {},
                      function(data) {
                          clear_details();
                          show_name(data.objects[0]);
                          show_image(data.objects[0].image);
                          show_timecards(data.objects[0].timecards);
                      })

        .error(function(jqXHR, textStatus, errorThrown) {
            show_error(errorThrown);
        })
    }

    function lookup_timecard(uri) {
        new $.getJSON(uri,
                      {},
                      function(data) {
                          active_timecard = uri;
                          show_details(data);
                          show_stamps(data.pairs);
                      })

        .error(function(jqXHR, textStatus, errorThrown) {
            show_error(errorThrown);
        })
    }


    $(document).ready(function() {

        var wsurim = "{{ RFID_URL }}";
        webSocketm = new WebSocket(wsurim);
        webSocketm.onmessage = function(e) { onMessage(e) };

        function onMessage(e)
        {
            var fields = eval("(" + e.data + ")");
    
            if ("heartbeat" in fields) {
                document.getElementById("heartbeat").innerHTML = fields.heartbeat.split(".")[0]

            } else {

                lookup_profile_rfid(fields.rfid);
            }
        }
        clear_details();
    });
</script>

{% endblock %}


{% block sidebar %}
{% endblock %}


{% block content %}
    <div id="error"></div>
    <div id="heartbeat"></div>
    <div id="rfid"></div>
    <div id="profile"></div>
    <div id="profile_image"><img id="profile_face" height="160" width="120" src="{{ STATIC_URL }}/images/blank.jpg"/></div>
    <div id="timecards"></div>
    <div id="details"></div>
    <div id="stamps"></div>
{% endblock %}
